package com.albandroid.filmoteca;

import com.albandroid.filmoteca.utils.*;


import android.app.Activity;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.Window;
import android.webkit.WebView;
import android.widget.TextView;

public class DetalleActivity extends Activity implements Runnable{
/** Called when the activity is first created. */
	String info;
	Dialog dialog;
	WebView webview;
	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		//Esto debe ir antes del setContentview
    	requestWindowFeature(Window.FEATURE_CUSTOM_TITLE);
    	setContentView(R.layout.detalle);
    	//El setFeatureInt debe ir despues del setContentView
    	getWindow().setFeatureInt(Window.FEATURE_CUSTOM_TITLE, R.layout.detalle_title);
    	TextView tituloDetalle=(TextView) findViewById(R.id.detalleTitle);
    	tituloDetalle.setText(
    			this.getIntent().getExtras().getString(Constants.PARAM_ID_TITULO).substring(1));
       
    	webview =(WebView)findViewById(R.id.webview);
        dialog = ProgressDialog.show(this, "", 
         		"Cargando...", true,false);
        Thread thread=new Thread(this);
        thread.start();
      
    }
	@Override
	public boolean onCreateOptionsMenu(Menu menu){
		super.onCreateOptionsMenu(menu);
		MenuInflater inflater = getMenuInflater();
		inflater.inflate(R.menu.sharewith, menu);
		return true;
	}
	@Override
	public boolean onOptionsItemSelected(MenuItem item){
		Intent intent = new Intent(Intent.ACTION_SEND);
		String titulo=this.getIntent().getExtras().getString(Constants.PARAM_ID_TITULO);
		String fecha="Fecha: "+this.getIntent().getExtras().getString(Constants.PARAM_ID_FECHA);
		String info= "Voy a ir a la Filmoteca a ver:\nTÃ­tulo: "+titulo+"\n"+fecha;
		String url;
		switch(item.getItemId()){
		case R.id.compartir:
			intent.setType("text/plain");
			intent.putExtra(Intent.EXTRA_SUBJECT, "Filmoteca de Albacete");
			intent.putExtra(Intent.EXTRA_TEXT, info);
			
			startActivity(Intent.createChooser(intent, getString(R.string.image_title_desc)));
			break;
		case R.id.navegar:
			url=this.getIntent().getExtras().getString(Constants.PARAM_ID_URL);
			Intent i_navegar = new Intent(Intent.ACTION_VIEW,Uri.parse(url));
			startActivity(i_navegar);
			break;
		case R.id.filmaffinity:
			url="";
			titulo=titulo.replace(" ", "+");
			
			//Le quito los acentos
			titulo=StringUtils.removeAccents(titulo);
			url="http://m.filmaffinity.com/es/search.php?stext="+titulo;
			Intent i_filmaffinity = new Intent(Intent.ACTION_VIEW,Uri.parse(url));
			startActivity(i_filmaffinity);
			break;
		}
		return false;
	}
	private String getInfo(){
		String pagina,res;
		pagina=ConexionHTTP.DownloadText(this.getIntent().getExtras().getString(Constants.PARAM_ID_URL));
		
        //Style
		String style="<style type=\"text/css\">img{ max-width:100%!important; height:auto!important;} strong{font-size:13px;} " +
				"*{background-color:#f3f3f3!important;}"+
				"a{font-size:15px!important;}"+
				"p{text-align:center;}"+
				".documentDescription{font-weight:bold;color:#000000; text-align:center;}"+
				".tablaeventos table{ width:100%!important;}"+
				".tablaeventos td{width:50%!important;}"+
				"a {color:#000000; font-weight:bold;}"+
				".vevent{font-size:15px!important; color:#5f5c5c;}"+
				"td{ font-size:15px!important;line-height:18px; vertical-align:top;}"+
				"table{border:1px solid #848484;}"+
				"th{float:left!important;font-size:13px!important;}</style>";
		
        //Parseando Info 
		pagina=pagina.substring(pagina.indexOf("<div class=\"vevent\">"));
		res=style+pagina.substring(0,pagina.indexOf("<div class=\"relatedItems\">"));
		res=res.replaceAll("\\<th", "<td");
		res=res.replaceAll("<\\/th", "</td");
		return res;
	}

public void run() {
	// TODO Auto-generated method stub
	info=getInfo();
	handler.sendEmptyMessage(0);
	
}
Handler handler=new Handler(){
		public void handleMessage(Message msg) {
			info=StringUtils.unescapeHTML(info);
			webview.loadDataWithBaseURL (null, info, "text/html", "utf-8", 
					"about:blank"); 
			//Quitamos la ventana de cargando
			dialog.dismiss();
		
		}};
}